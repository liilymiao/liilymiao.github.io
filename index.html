---
layout: default
title: Home
---

<!-- About 多语言：用 html[data-ui-lang] 控制显示，首访兜底显示英文 -->
<style>
  #aboutContent .lang-block { display: none; }
  html[data-ui-lang="en"] #aboutContent .lang-block[data-lang="en"] { display: block; }
  html[data-ui-lang="zh"] #aboutContent .lang-block[data-lang="zh"] { display: block; }
  /* 若尚未设置 data-ui-lang（脚本未跑时），先显示英文以避免空白 */
  html:not([data-ui-lang]) #aboutContent .lang-block[data-lang="en"] { display:block; }
</style>

<h1 data-i18n="home.latest">Latest posts</h1>
<ul id="postList">
  {% for post in site.posts %}
    <li>
      <a href="{{ post.url | relative_url }}"
         class="i18n-post-title"
         data-title-zh="{{ post.title | escape }}"
         data-title-en="{{ post.title_en | default: post.title | escape }}">
        {{ post.title_en | default: post.title }}
      </a>
      <small> — {{ post.date | date: "%Y-%m-%d" }}</small>
    </li>
  {% endfor %}
</ul>

<hr>

<section id="about">
  <h2 data-i18n="home.about">About</h2>
  <div id="aboutContent">
    <div class="lang-block" data-lang="en">
      {% include about_en.html %}
    </div>
    <div class="lang-block" data-lang="zh">
      {% include about_zh.html %}
    </div>
  </div>
</section>

<hr>

<section id="albums">
  <h2 data-i18n="home.albums">Albums</h2>
  {%- assign albums_all = site.pages | where: "layout", "album" -%}
  {%- assign locs = albums_all | map: "location" | uniq | sort -%}

  <div class="album-filters" id="albumLocFilters">
    <strong data-i18n="home.location">Location:</strong>
    <button type="button" data-loc="all" class="on" data-i18n="filters.all">All</button>
    {%- for loc in locs -%}
      {%- assign rep = albums_all | where: "location", loc | first -%}
      <button type="button" data-loc="{{ loc }}">{{ rep.location_name | default: loc }}</button>
    {%- endfor -%}
  </div>

  <div class="albums-grid" id="albumGrid">
    {%- assign cards = albums_all | sort: "date" | reverse -%}
    {%- for a in cards -%}
      <a class="album-card"
         href="{{ a.url | relative_url }}"
         data-location="{{ a.location | default: '' }}"
         data-title-zh="{{ a.title | escape }}"
         data-title-en="{{ a.title_en | default: a.title | escape }}">
        {% if a.cover %}
          <img src="{{ a.cover | relative_url }}" alt="{{ a.title_en | default: a.title }}" loading="lazy">
        {% endif %}
        <div class="meta">
          <h3>{{ a.title_en | default: a.title }}</h3>
          {% if a.date %}<small>{{ a.date | date: "%Y-%m-%d" }}</small>{% endif %}
        </div>
      </a>
    {%- endfor -%}
  </div>

  <p><a href="{{ '/albums/' | relative_url }}" data-i18n="home.viewall">View all →</a></p>
</section>

<hr style="margin:2rem 0; opacity:.2">

<section id="photos">
  <h2 data-i18n="home.photos">Photos</h2>

  {%- assign lens_pool = "" | split: "" -%}
  {%- for a in albums_all -%}
    {%- if a.photos -%}
      {%- for p in a.photos -%}
        {%- if p.lens -%}
          {%- assign L = p.lens -%}
          {%- if L.first -%}
            {%- assign lens_pool = lens_pool | concat: L -%}
          {%- else -%}
            {%- assign L_arr = L | replace: ',', ' ' | split: ' ' | reject: '' -%}
            {%- assign lens_pool = lens_pool | concat: L_arr -%}
          {%- endif -%}
        {%- endif -%}
      {%- endfor -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign lenses = lens_pool | uniq | sort -%}

  <div class="album-filters" id="photoFilters">
    <strong data-i18n="filters.filter">Filter:</strong>
    <button type="button" data-lens="all" class="on" data-i18n="filters.all">All</button>
    {%- for l in lenses -%}
      <button type="button" data-lens="{{ l }}">{{ l }}</button>
    {%- endfor -%}
  </div>

  <div class="photos-grid" id="photoGrid">
    {%- assign photo_items = "" | split: "" -%}
    {%- for a in albums_all -%}
      {%- if a.photos -%}
        {%- for p in a.photos -%}
          {%- assign when_raw = p.taken_at | default: a.date -%}
          {%- assign day_only = when_raw | date: "%Y-%m-%d" -%}
          {%- assign ts = day_only | date: "%s" -%}
          {%- assign src = p.src -%}
          {%- assign thumb = src | replace:'/assets/img/albums/','/assets/thumbs/albums/' | replace: '.jpg','-thumb.jpg' -%}
          {%- assign large = src | replace:'/assets/img/albums/','/assets/thumbs/albums/' | replace: '.jpg','-large.jpg' -%}
          {%- capture row -%}
{{ ts }}||{{ src }}||{{ thumb }}||{{ large }}||{{ p.lens | join: ',' | default: p.lens }}||{{ p.caption | default: a.title }}||{{ a.url }}||{{ day_only }}
          {%- endcapture -%}
          {%- assign photo_items = photo_items | push: row | compact -%}
        {%- endfor -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign photos_sorted = photo_items | sort | reverse -%}

    {%- for row in photos_sorted -%}
      {%- assign parts = row | split: "||" -%}
      {%- assign _thumb     = parts[2] -%}
      {%- assign _large     = parts[3] -%}
      {%- assign _lenses    = parts[4] -%}
      {%- assign _caption   = parts[5] -%}
      {%- assign _album_url = parts[6] -%}
      {%- assign _taken_at  = parts[7] -%}

      <a class="photo-card" href="{{ _album_url | relative_url }}"
         data-lenses="{{ _lenses | replace: ',', ' ' | default: '' }}"
         title="{{ _caption }}">
        <img src="{{ _thumb | relative_url }}"
             data-full="{{ _large | relative_url }}"
             alt="{{ _caption }}"
             loading="lazy" decoding="async" width="480" height="320">
        <div class="ph-meta">
          <small>{{ _taken_at }}</small>
          {%- if _lenses and _lenses != '' -%}<small> · {{ _lenses | replace: ',', ', ' }}</small>{% endif %}
        </div>
      </a>
    {%- endfor -%}
  </div>
</section>

<link rel="stylesheet" href="https://unpkg.com/photoswipe@5/dist/photoswipe.css">
<script type="module">
  import PhotoSwipe from 'https://unpkg.com/photoswipe@5/dist/photoswipe.esm.js';

  // 从可见卡片构建 items；强制用 data-full（大图）+ 正确宽高（按缩略图比例推算）
  function buildItems() {
    const nodes = Array.from(document.querySelectorAll('#photoGrid .photo-card img'))
      .filter(img => (img.closest('.photo-card')?.style.display || '') !== 'none');

    return nodes.map(img => {
      const thumbW = img.naturalWidth  || img.width  || 480;
      const thumbH = img.naturalHeight || img.height || 320;
      const aspect = thumbH / thumbW;

      // 目标大图宽度（与你生成 large 时一致；如果你用 1600 宽，这里就 1600）
      const w = 1600;
      const h = Math.max(1, Math.round(w * aspect));

      const big = img.getAttribute('data-full') || img.dataset.full || img.src; // ✅ 一律取大图
      return { src: big, msrc: img.currentSrc || img.src, width: w, height: h, alt: img.alt || '' };
    });
  }

  function openLightbox(clickedImg) {
    const imgs  = Array.from(document.querySelectorAll('#photoGrid .photo-card img'))
      .filter(img => (img.closest('.photo-card')?.style.display || '') !== 'none');
    const items = buildItems();

    const curBig = clickedImg.getAttribute('data-full') || clickedImg.dataset.full || clickedImg.src;
    const idx    = Math.max(0, items.findIndex(it => it.src === curBig));

    const pswp = new PhotoSwipe({
      index: idx,
      dataSource: items,
      bgOpacity: 0.95,
      wheelToZoom: true,
    });

    pswp.init();
  }

  const grid = document.getElementById('photoGrid');
  if (grid) {
    grid.addEventListener('click', (e) => {
      const card = e.target.closest('.photo-card');
      if (!card) return;
      e.preventDefault();
      const img = card.querySelector('img');
      if (img) openLightbox(img);
    });
  }
</script>

<!-- 语言与筛选：简化版 -->
<script>
(function () {
  const STORE = 'lang';

  /* 文案字典 */
  const dict = {
    en: {
      "home.latest":"Latest posts",
      "home.about":"About",
      "home.albums":"Albums",
      "home.location":"Location:",
      "home.viewall":"View all →",
      "home.photos":"Photos",
      "filters.all":"All",
      "filters.filter":"Filter:"
    },
    zh: {
      "home.latest":"最新文章",
      "home.about":"关于",
      "home.albums":"相册",
      "home.location":"地点：",
      "home.viewall":"查看全部 →",
      "home.photos":"照片",
      "filters.all":"全部",
      "filters.filter":"筛选："
    }
  };

  /* 应用文案/标题 */
  function applyText(lang){
    const map = dict[lang] || dict.en;
    document.querySelectorAll('[data-i18n]').forEach(el=>{
      const key = el.getAttribute('data-i18n');
      if (map[key] != null) el.textContent = map[key];
    });
  }
  function applyPostTitles(lang){
    document.querySelectorAll('.i18n-post-title').forEach(a=>{
      const zh = a.dataset.titleZh;
      const en = a.dataset.titleEn || zh || a.textContent;
      a.textContent = (lang==='zh') ? (zh || en) : (en || zh);
    });
  }
  function applyAlbumCardTitles(lang){
    document.querySelectorAll('.album-card').forEach(card=>{
      const zh = card.dataset.titleZh;
      const en = card.dataset.titleEn || zh;
      const h3 = card.querySelector('h3');
      if (h3) h3.textContent = (lang === 'zh') ? zh : en;
    });
  }

  /* 初始化语言（首访固定 en），并写到 <html data-ui-lang> */
  let lang = localStorage.getItem(STORE);
  if (!lang) { lang = 'en'; localStorage.setItem(STORE, lang); }
  document.documentElement.setAttribute('data-ui-lang', lang);

  applyText(lang);
  applyPostTitles(lang);
  applyAlbumCardTitles(lang);

  /* 响应全局语言切换（default.html 会派发 langchange） */
  window.addEventListener('langchange', e=>{
    const next = e.detail || 'en';
    localStorage.setItem(STORE, next);
    document.documentElement.setAttribute('data-ui-lang', next);
    applyText(next);
    applyPostTitles(next);
    applyAlbumCardTitles(next);
  });

  /* Albums 筛选 */
  (function initAlbumFilter(){
    const ag = document.getElementById('albumGrid');
    const ab = document.getElementById('albumLocFilters');
    if (!ag || !ab) return;
    const cards = Array.from(ag.querySelectorAll('.album-card'));
    const btns  = Array.from(ab.querySelectorAll('button[data-loc]'));
    function setActive(btn){ btns.forEach(b=>b.classList.toggle('on', b===btn)); }
    function apply(loc){
      cards.forEach(c=>{
        const v = c.getAttribute('data-location') || '';
        c.style.display = (loc === 'all' || v === loc) ? '' : 'none';
      });
      try {
        const u = new URL(window.location.href);
        if (loc === 'all') u.searchParams.delete('loc'); else u.searchParams.set('loc', loc);
        history.replaceState(null, '', u.toString());
      } catch(_) {}
    }
    let init = 'all';
    try {
      const p = new URL(window.location.href).searchParams.get('loc');
      if (btns.some(b=>b.dataset.loc === p)) init = p;
    } catch(_) {}
    const startBtn = btns.find(b=>b.dataset.loc === init) || btns[0];
    if (startBtn){ setActive(startBtn); apply(startBtn.dataset.loc); }
    ab.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-loc]'); if (!btn) return;
      setActive(btn); apply(btn.dataset.loc);
    });
  })();

  /* Photos 筛选 */
  (function initPhotoFilter(){
    const pg = document.getElementById('photoGrid');
    const pb = document.getElementById('photoFilters');
    if (!pg || !pb) return;
    const cards = Array.from(pg.querySelectorAll('.photo-card'));
    const btns  = Array.from(pb.querySelectorAll('button[data-lens]'));
    function setActive(btn){ btns.forEach(b=>b.classList.toggle('on', b===btn)); }
    function apply(l){
      cards.forEach(c=>{
        const set = (c.getAttribute('data-lenses') || '').split(/\s+/).filter(Boolean);
        c.style.display = (l === 'all' || set.includes(l)) ? '' : 'none';
      });
      try {
        const u = new URL(window.location.href);
        if (l === 'all') u.searchParams.delete('lens'); else u.searchParams.set('lens', l);
        history.replaceState(null, '', u.toString());
      } catch(_) {}
    }
    let init = 'all';
    try {
      const p = new URL(window.location.href).searchParams.get('lens');
      if (btns.some(b=>b.dataset.lens === p)) init = p;
    } catch(_) {}
    const startBtn = btns.find(b=>b.dataset.lens === init) || btns[0];
    if (startBtn){ setActive(startBtn); apply(startBtn.dataset.lens); }
    pb.addEventListener('click', e=>{
      const btn = e.target.closest('button[data-lens]'); if (!btn) return;
      setActive(btn); apply(btn.dataset.lens);
    });
  })();
})();
</script>